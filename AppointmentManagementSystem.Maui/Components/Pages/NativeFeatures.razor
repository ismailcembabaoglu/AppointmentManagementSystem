@page "/native-features"
@using AppointmentManagementSystem.Maui.Services
@inject ICameraService CameraService
@inject ILocationService LocationService
@inject NotificationService NotificationService

<PageTitle>Native Features</PageTitle>

<div class="container mt-4">
    <RadzenCard>
        <h3 class="mb-4">üì± Native Features Demo</h3>
        
        <!-- Camera Section -->
        <RadzenCard Class="mb-4">
            <h4>üì∑ Camera</h4>
            <div class="d-flex gap-2 mb-3">
                <RadzenButton Text="Take Photo" Icon="photo_camera" Click="@TakePhoto" />
                <RadzenButton Text="Pick from Gallery" Icon="photo_library" Click="@PickPhoto" />
            </div>
            
            @if (!string.IsNullOrEmpty(photoPath))
            {
                <div class="mt-3">
                    <img src="@photoPath" alt="Captured photo" style="max-width: 300px; border-radius: 8px;" />
                    <p class="text-muted mt-2">Photo saved at: @photoPath</p>
                </div>
            }
        </RadzenCard>

        <!-- Location Section -->
        <RadzenCard>
            <h4>üìç Location</h4>
            <RadzenButton Text="Get Current Location" Icon="location_on" Click="@GetLocation" Class="mb-3" />
            
            @if (currentLocation != null)
            {
                <div class="alert alert-info">
                    <h5>Your Location:</h5>
                    <p><strong>Latitude:</strong> @currentLocation.Latitude.ToString("F6")</p>
                    <p><strong>Longitude:</strong> @currentLocation.Longitude.ToString("F6")</p>
                    <p><strong>Accuracy:</strong> @currentLocation.Accuracy?.ToString("F2") meters</p>
                    @if (currentLocation.Timestamp != null)
                    {
                        <p><strong>Time:</strong> @currentLocation.Timestamp.Value.LocalDateTime</p>
                    }
                </div>
            }
        </RadzenCard>
    </RadzenCard>
</div>

@code {
    private string? photoPath;
    private Microsoft.Maui.Devices.Sensors.Location? currentLocation;

    private async Task TakePhoto()
    {
        try
        {
            photoPath = await CameraService.TakePhotoAsync();
            
            if (photoPath != null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Photo captured successfully!",
                    Duration = 3000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Cancelled",
                    Detail = "Photo capture was cancelled",
                    Duration = 3000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to capture photo: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private async Task PickPhoto()
    {
        try
        {
            photoPath = await CameraService.PickPhotoAsync();
            
            if (photoPath != null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Photo selected successfully!",
                    Duration = 3000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Cancelled",
                    Detail = "Photo selection was cancelled",
                    Duration = 3000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to select photo: {ex.Message}",
                Duration = 4000
            });
        }
    }

    private async Task GetLocation()
    {
        try
        {
            currentLocation = await LocationService.GetCurrentLocationAsync();
            
            if (currentLocation != null)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Location Found",
                    Detail = $"Lat: {currentLocation.Latitude:F6}, Lon: {currentLocation.Longitude:F6}",
                    Duration = 4000
                });
            }
            else
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Permission Denied",
                    Detail = "Location permission was denied",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to get location: {ex.Message}",
                Duration = 4000
            });
        }
    }
}
