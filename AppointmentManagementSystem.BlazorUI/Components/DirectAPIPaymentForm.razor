@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices
@using Radzen
@inject IPaymentApiService PaymentApiService
@inject NotificationService NotificationService

<RadzenCard Style="@cardStyle">
    <RadzenStack Orientation="Orientation.Vertical" Gap="24px">
        <!-- Header -->
        <div style="text-align: center;">
            <div style="width: 80px; height: 80px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <RadzenIcon Icon="credit_card" Style="font-size: 40px; color: white;" />
            </div>
            <RadzenText TextStyle="TextStyle.H4" Style="margin-top: 16px; margin-bottom: 8px;">
                ðŸ’³ Kart Bilgileriniz
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
                GÃ¼venli Ã¶deme iÃ§in kart bilgilerinizi girin
            </RadzenText>
        </div>

        <!-- Payment Info Alert -->
        <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
            <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600; margin: 0;">
                    ðŸ“‹ Ã–deme Bilgileri
                </RadzenText>
                <RadzenText Style="font-size: 14px;">â€¢ <strong>Kart DoÄŸrulama:</strong> 1 TL (Tek seferlik)</RadzenText>
                <RadzenText Style="font-size: 14px;">â€¢ <strong>AylÄ±k Abonelik:</strong> 700 TL otomatik tahsilat</RadzenText>
                <RadzenText Style="font-size: 14px;">â€¢ <strong>Ä°lk Tahsilat:</strong> 30 gÃ¼n sonra baÅŸlar</RadzenText>
                <RadzenText Style="font-size: 14px;">â€¢ <strong>GÃ¼venlik:</strong> Kart bilgileriniz PayTR tarafÄ±ndan gÃ¼venle saklanÄ±r</RadzenText>
            </RadzenStack>
        </RadzenAlert>

        <!-- Card Form -->
        <RadzenStack Orientation="Orientation.Vertical" Gap="16px">
            <!-- Kart Ãœzerindeki Ad -->
            <RadzenFormField Text="Kart Ãœzerindeki Ad *" Style="width: 100%;">
                <RadzenTextBox @bind-Value="@cardOwner" 
                               Placeholder="Ã–rn: AHMET YILMAZ" 
                               Style="width: 100%; height: 50px; text-transform: uppercase;" 
                               MaxLength="50"
                               Disabled="@IsProcessing" />
            </RadzenFormField>

            <!-- Kart NumarasÄ± -->
            <RadzenFormField Text="Kart NumarasÄ± *" Style="width: 100%;">
                <RadzenTextBox @bind-Value="@cardNumber" 
                               Placeholder="1234 5678 9012 3456" 
                               @oninput="@FormatCardNumber"
                               Style="width: 100%; height: 50px; letter-spacing: 2px; font-size: 16px;" 
                               MaxLength="19"
                               Disabled="@IsProcessing" />
                @if (!string.IsNullOrEmpty(cardNumber))
                {
                    <div style="margin-top: 8px;">
                        <RadzenBadge Text="@GetCardBrand()" BadgeStyle="BadgeStyle.Info" />
                    </div>
                }
            </RadzenFormField>

            <!-- Son Kullanma Tarihi ve CVV -->
            <RadzenRow Gap="16px">
                <RadzenColumn Size="12" SizeSM="7">
                    <RadzenFormField Text="Son Kullanma Tarihi *" Style="width: 100%;">
                        <RadzenRow Gap="8px">
                            <RadzenColumn Size="6">
                                <RadzenDropDown @bind-Value="@expiryMonth" 
                                                Data="@months" 
                                                Placeholder="Ay" 
                                                Style="width: 100%; height: 50px;"
                                                Disabled="@IsProcessing" />
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <RadzenDropDown @bind-Value="@expiryYear" 
                                                Data="@years" 
                                                Placeholder="YÄ±l" 
                                                Style="width: 100%; height: 50px;"
                                                Disabled="@IsProcessing" />
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeSM="5">
                    <RadzenFormField Text="CVV *" Style="width: 100%;">
                        <RadzenTextBox @bind-Value="@cvv" 
                                       Placeholder="123" 
                                       Style="width: 100%; height: 50px; text-align: center; font-size: 18px; letter-spacing: 2px;" 
                                       MaxLength="4"
                                       Password="true"
                                       Disabled="@IsProcessing" />
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>
        </RadzenStack>

        <!-- Security Badge -->
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; background: var(--rz-success-lighter); border-radius: 8px;">
            <RadzenIcon Icon="lock" Style="color: var(--rz-success);" />
            <RadzenText Style="color: var(--rz-success); font-size: 14px; margin: 0;">
                256-bit SSL ile ÅŸifrelenmiÅŸ gÃ¼venli Ã¶deme
            </RadzenText>
        </div>

        <!-- Submit Button -->
        <RadzenButton Text="@(IsProcessing ? "Ä°ÅŸleniyor..." : "Ã–demeyi Tamamla")" 
                      Icon="@(IsProcessing ? "hourglass_empty" : "credit_card")" 
                      ButtonStyle="ButtonStyle.Success" 
                      Size="ButtonSize.Large"
                      Click="@HandleSubmit"
                      Disabled="@(IsProcessing || !IsFormValid())"
                      Style="width: 100%; height: 56px; font-size: 16px; font-weight: 600;" />

        <!-- Test Card Info -->
        @if (IsTestMode)
        {
            <RadzenAlert AlertStyle="AlertStyle.Warning" Variant="Variant.Flat">
                <RadzenText TextStyle="TextStyle.Subtitle2" Style="font-weight: 600; margin-bottom: 8px;">
                    ðŸ§ª Test Modunda Ã‡alÄ±ÅŸÄ±yorsunuz
                </RadzenText>
                <RadzenText Style="font-size: 13px; margin-bottom: 4px;"><strong>Test KartÄ±:</strong> 4111 1111 1111 1111</RadzenText>
                <RadzenText Style="font-size: 13px; margin-bottom: 4px;"><strong>CVV:</strong> 123</RadzenText>
                <RadzenText Style="font-size: 13px;"><strong>Tarih:</strong> 12/25</RadzenText>
            </RadzenAlert>
        }
    </RadzenStack>
</RadzenCard>

@code {
    [Parameter] public int BusinessId { get; set; }
    [Parameter] public string Email { get; set; } = "";
    [Parameter] public string BusinessName { get; set; } = "";
    [Parameter] public string OwnerName { get; set; } = "";
    [Parameter] public string PhoneNumber { get; set; } = "";
    [Parameter] public string Address { get; set; } = "";
    [Parameter] public EventCallback OnPaymentSuccess { get; set; }
    [Parameter] public EventCallback<string> OnPaymentFailed { get; set; }
    [Parameter] public bool IsTestMode { get; set; } = true;

    private bool IsProcessing = false;
    private string cardOwner = "";
    private string cardNumber = "";
    private string expiryMonth = "";
    private string expiryYear = "";
    private string cvv = "";

    private List<string> months = Enumerable.Range(1, 12).Select(m => m.ToString("D2")).ToList();
    private List<string> years = Enumerable.Range(DateTime.Now.Year, 11).Select(y => y.ToString().Substring(2)).ToList();

    private string cardStyle => $@"
        max-width: 600px; 
        margin: 0 auto; 
        padding: 32px; 
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 2px solid var(--rz-border-color);
        @media (max-width: 768px) {{
            padding: 20px;
        }}
    ";

    protected override void OnInitialized()
    {
        // Test mode iÃ§in default deÄŸerler
        if (IsTestMode)
        {
            cardOwner = OwnerName.ToUpper();
        }
    }

    private void FormatCardNumber(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
        if (digitsOnly.Length > 16)
            digitsOnly = digitsOnly.Substring(0, 16);

        // Format as XXXX XXXX XXXX XXXX
        var formatted = "";
        for (int i = 0; i < digitsOnly.Length; i++)
        {
            if (i > 0 && i % 4 == 0)
                formatted += " ";
            formatted += digitsOnly[i];
        }

        cardNumber = formatted;
    }

    private string GetCardBrand()
    {
        var digits = new string(cardNumber.Where(char.IsDigit).ToArray());
        if (string.IsNullOrEmpty(digits)) return "";

        var firstDigit = digits[0];
        return firstDigit switch
        {
            '4' => "Visa",
            '5' => "Mastercard",
            '3' => "American Express",
            '6' => "Discover",
            _ => "Kart"
        };
    }

    private bool IsFormValid()
    {
        var digitsOnly = new string(cardNumber.Where(char.IsDigit).ToArray());
        
        return !string.IsNullOrWhiteSpace(cardOwner) &&
               digitsOnly.Length == 16 &&
               !string.IsNullOrWhiteSpace(expiryMonth) &&
               !string.IsNullOrWhiteSpace(expiryYear) &&
               cvv.Length >= 3 && cvv.Length <= 4;
    }

    private async Task HandleSubmit()
    {
        if (!IsFormValid())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "UyarÄ±", "LÃ¼tfen tÃ¼m kart bilgilerini eksiksiz doldurun.");
            return;
        }

        IsProcessing = true;
        StateHasChanged();

        try
        {
            var digitsOnly = new string(cardNumber.Where(char.IsDigit).ToArray());

            var request = new
            {
                businessId = BusinessId,
                email = Email,
                businessName = BusinessName,
                ownerName = OwnerName,
                phoneNumber = PhoneNumber,
                address = Address,
                cardOwner = cardOwner,
                cardNumber = digitsOnly,
                expiryMonth = expiryMonth,
                expiryYear = expiryYear,
                cvv = cvv
            };

            Console.WriteLine($"ðŸ”µ Sending Direct API payment request...");
            Console.WriteLine($"BusinessId: {BusinessId}, Email: {Email}");

            var response = await PaymentApiService.InitiateDirectCardRegistrationAsync(request);

            if (response.Success)
            {
                Console.WriteLine($"âœ… Payment initiated: {response.Data?.MerchantOid}");
                NotificationService.Notify(NotificationSeverity.Success, "BaÅŸarÄ±lÄ±", 
                    "Ã–demeniz iÅŸleniyor. LÃ¼tfen bekleyin...");

                // Webhook'u bekle (birkaÃ§ saniye)
                await Task.Delay(3000);

                await OnPaymentSuccess.InvokeAsync();
            }
            else
            {
                Console.WriteLine($"âŒ Payment failed: {response.Message}");
                NotificationService.Notify(NotificationSeverity.Error, "Hata", 
                    response.Message ?? "Ã–deme baÅŸlatÄ±lamadÄ±.");
                
                if (OnPaymentFailed.HasDelegate)
                    await OnPaymentFailed.InvokeAsync(response.Message ?? "Ã–deme baÅŸarÄ±sÄ±z");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Exception: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Hata", 
                $"Bir hata oluÅŸtu: {ex.Message}");
            
            if (OnPaymentFailed.HasDelegate)
                await OnPaymentFailed.InvokeAsync(ex.Message);
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }
}
