@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices
@using Radzen
@inject IPaymentApiService PaymentApiService
@inject NotificationService NotificationService
@inject DialogService DialogService

<RadzenStack Orientation="Orientation.Vertical" Gap="24px" Style="padding: 8px;">
    <!-- Header -->
    <div style="text-align: center;">
        <div style="width: 64px; height: 64px; margin: 0 auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <RadzenIcon Icon="credit_card" Style="font-size: 32px; color: white;" />
        </div>
        <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px; margin-bottom: 8px;">
            ðŸ”„ Kart GÃ¼ncelle
        </RadzenText>
        <RadzenText TextStyle="TextStyle.Body2" Style="color: var(--rz-text-secondary-color);">
            Yeni kart bilgilerinizi girin (1 TL doÄŸrulama Ã¼creti)
        </RadzenText>
    </div>

    <!-- Alert -->
    <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat">
        <RadzenStack Orientation="Orientation.Vertical" Gap="6px">
            <RadzenText Style="font-size: 13px; margin: 0;">â€¢ Yeni kartÄ±nÄ±z doÄŸrulandÄ±ktan sonra abonelik Ã¶demeleriniz bu karttan Ã§ekilecek</RadzenText>
            <RadzenText Style="font-size: 13px; margin: 0;">â€¢ 1 TL doÄŸrulama Ã¼creti alÄ±nacak</RadzenText>
            <RadzenText Style="font-size: 13px; margin: 0;">â€¢ Eski kartÄ±nÄ±z sistemden kaldÄ±rÄ±lacak</RadzenText>
        </RadzenStack>
    </RadzenAlert>

    <!-- Form -->
    <RadzenStack Orientation="Orientation.Vertical" Gap="16px">
        <!-- Kart Sahibi -->
        <RadzenFormField Text="Kart Ãœzerindeki Ad *" Style="width: 100%;">
            <RadzenTextBox @bind-Value="@cardOwner" 
                           Placeholder="Ã–rn: AHMET YILMAZ" 
                           Style="width: 100%; height: 48px; text-transform: uppercase;" 
                           MaxLength="50"
                           Disabled="@IsProcessing" />
        </RadzenFormField>

        <!-- Kart NumarasÄ± -->
        <RadzenFormField Text="Kart NumarasÄ± *" Style="width: 100%;">
            <RadzenTextBox @bind-Value="@cardNumber" 
                           Placeholder="1234 5678 9012 3456" 
                           @oninput="@FormatCardNumber"
                           Style="width: 100%; height: 48px; letter-spacing: 2px;" 
                           MaxLength="19"
                           Disabled="@IsProcessing" />
            @if (!string.IsNullOrEmpty(cardNumber))
            {
                <div style="margin-top: 6px;">
                    <RadzenBadge Text="@GetCardBrand()" BadgeStyle="BadgeStyle.Info" />
                </div>
            }
        </RadzenFormField>

        <!-- Son Kullanma & CVV -->
        <RadzenRow Gap="12px">
            <RadzenColumn Size="12" SizeSM="7">
                <RadzenFormField Text="Son Kullanma Tarihi *" Style="width: 100%;">
                    <RadzenRow Gap="8px">
                        <RadzenColumn Size="6">
                            <RadzenDropDown @bind-Value="@expiryMonth" 
                                            Data="@months" 
                                            Placeholder="Ay" 
                                            Style="width: 100%; height: 48px;"
                                            Disabled="@IsProcessing" />
                        </RadzenColumn>
                        <RadzenColumn Size="6">
                            <RadzenDropDown @bind-Value="@expiryYear" 
                                            Data="@years" 
                                            Placeholder="YÄ±l" 
                                            Style="width: 100%; height: 48px;"
                                            Disabled="@IsProcessing" />
                        </RadzenColumn>
                    </RadzenRow>
                </RadzenFormField>
            </RadzenColumn>
            <RadzenColumn Size="12" SizeSM="5">
                <RadzenFormField Text="CVV *" Style="width: 100%;">
                    <RadzenTextBox @bind-Value="@cvv" 
                                   Placeholder="123" 
                                   Style="width: 100%; height: 48px; text-align: center; font-size: 16px; letter-spacing: 2px;" 
                                   MaxLength="4"
                                   Password="true"
                                   Disabled="@IsProcessing" />
                </RadzenFormField>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>

    <!-- Actions -->
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="12px" Style="margin-top: 8px;">
        <RadzenButton Text="Ä°ptal" 
                      ButtonStyle="ButtonStyle.Light" 
                      Click="@HandleCancel"
                      Disabled="@IsProcessing"
                      Style="width: 120px;" />
        <RadzenButton Text="@(IsProcessing ? "Ä°ÅŸleniyor..." : "KartÄ± GÃ¼ncelle")" 
                      Icon="@(IsProcessing ? "hourglass_empty" : "check")" 
                      ButtonStyle="ButtonStyle.Success" 
                      Click="@HandleSubmit"
                      Disabled="@(IsProcessing || !IsFormValid())"
                      Style="width: 160px;" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public int BusinessId { get; set; }
    [Parameter] public string Email { get; set; } = "";
    [Parameter] public string BusinessName { get; set; } = "";
    [Parameter] public string OwnerName { get; set; } = "";

    private bool IsProcessing = false;
    private string cardOwner = "";
    private string cardNumber = "";
    private string expiryMonth = "";
    private string expiryYear = "";
    private string cvv = "";

    private List<string> months = Enumerable.Range(1, 12).Select(m => m.ToString("D2")).ToList();
    private List<string> years = Enumerable.Range(DateTime.Now.Year, 11).Select(y => y.ToString().Substring(2)).ToList();

    protected override void OnInitialized()
    {
        cardOwner = OwnerName.ToUpper();
    }

    private void FormatCardNumber(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? "";
        var digitsOnly = new string(input.Where(char.IsDigit).ToArray());
        
        if (digitsOnly.Length > 16)
            digitsOnly = digitsOnly.Substring(0, 16);

        var formatted = "";
        for (int i = 0; i < digitsOnly.Length; i++)
        {
            if (i > 0 && i % 4 == 0)
                formatted += " ";
            formatted += digitsOnly[i];
        }

        cardNumber = formatted;
    }

    private string GetCardBrand()
    {
        var digits = new string(cardNumber.Where(char.IsDigit).ToArray());
        if (string.IsNullOrEmpty(digits)) return "";

        var firstDigit = digits[0];
        return firstDigit switch
        {
            '4' => "Visa",
            '5' => "Mastercard",
            '3' => "American Express",
            '6' => "Discover",
            _ => "Kart"
        };
    }

    private bool IsFormValid()
    {
        var digitsOnly = new string(cardNumber.Where(char.IsDigit).ToArray());
        
        return !string.IsNullOrWhiteSpace(cardOwner) &&
               digitsOnly.Length == 16 &&
               !string.IsNullOrWhiteSpace(expiryMonth) &&
               !string.IsNullOrWhiteSpace(expiryYear) &&
               cvv.Length >= 3 && cvv.Length <= 4;
    }

    private async Task HandleSubmit()
    {
        if (!IsFormValid())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "UyarÄ±", "LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
            return;
        }

        IsProcessing = true;
        StateHasChanged();

        try
        {
            var digitsOnly = new string(cardNumber.Where(char.IsDigit).ToArray());

            var request = new
            {
                businessId = BusinessId,
                email = Email,
                businessName = BusinessName,
                ownerName = OwnerName,
                phoneNumber = "5555555555",
                address = "TÃ¼rkiye",
                cardOwner = cardOwner,
                cardNumber = digitsOnly,
                expiryMonth = expiryMonth,
                expiryYear = expiryYear,
                cvv = cvv
            };

            Console.WriteLine($"ðŸ”µ Updating card for Business {BusinessId}");

            var response = await PaymentApiService.InitiateDirectCardRegistrationAsync(request);

            if (response.Success)
            {
                Console.WriteLine($"âœ… Card update initiated: {response.Data?.MerchantOid}");
                NotificationService.Notify(NotificationSeverity.Success, "BaÅŸarÄ±lÄ±", 
                    "KartÄ±nÄ±z gÃ¼ncelleniyor. LÃ¼tfen bekleyin...");

                await Task.Delay(2000);
                DialogService.Close(true);
            }
            else
            {
                Console.WriteLine($"âŒ Card update failed: {response.Message}");
                NotificationService.Notify(NotificationSeverity.Error, "Hata", 
                    response.Message ?? "Kart gÃ¼ncellenemedi.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âŒ Exception: {ex.Message}");
            NotificationService.Notify(NotificationSeverity.Error, "Hata", 
                $"Bir hata oluÅŸtu: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
            StateHasChanged();
        }
    }

    private void HandleCancel()
    {
        DialogService.Close(false);
    }
}
