@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor
@inject IJSRuntime JSRuntime

<div style="padding: 24px;">
    @if (ErrorMessage != null)
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
            <RadzenText>@ErrorMessage</RadzenText>
        </RadzenAlert>
    }
    else if (IsLoading)
    {
        <div style="text-align: center; padding: 48px;">
            <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large">
                <Template>‚è≥</Template>
            </RadzenProgressBarCircular>
            <RadzenText TextStyle="TextStyle.H6" Style="margin-top: 16px; color: var(--rz-text-secondary-color);">
                √ñdeme formu y√ºkleniyor...
            </RadzenText>
        </div>
    }
    else if (!string.IsNullOrEmpty(IFrameUrl))
    {
        <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <RadzenText TextStyle="TextStyle.H5" Style="margin-bottom: 16px; text-align: center; color: var(--rz-primary);">
                üí≥ Kart Bilgilerinizi Girin
            </RadzenText>
            
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Style="margin-bottom: 16px;">
                <RadzenText Style="font-size: 14px;">
                    üîí Kart bilgileriniz g√ºvenli bir ≈üekilde PayTR tarafƒ±ndan saklanacaktƒ±r. Aylƒ±k 700 TL abonelik √ºcreti otomatik olarak tahsil edilecektir.
                </RadzenText>
            </RadzenAlert>

            <div style="text-align: center; margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px;">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #1976d2;">
                    <strong>Test Kart Bilgileri:</strong><br/>
                    <strong>Kart No:</strong> 9792030394440796 | <strong>CVV:</strong> 000 | <strong>Tarih:</strong> Herhangi (√∂rn: 12/25)
                </RadzenText>
            </div>

            <div style="width: 100%; min-height: 600px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f5f5f5;">
                <iframe src="@IFrameUrl" 
                        id="paytriframe" 
                        frameborder="0" 
                        scrolling="no" 
                        style="width: 100%; border: none; background: white;">
                </iframe>
            </div>

            <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center; margin-top: 16px; color: var(--rz-text-secondary-color);">
                ‚ö†Ô∏è Tarayƒ±cƒ± penceresini kapatmayƒ±n. √ñdeme i≈ülemi tamamlandƒ±ktan sonra otomatik olarak y√∂nlendirileceksiniz.
            </RadzenText>
        </div>
    }
</div>

@code {
    [Parameter]
    public Dictionary<string, string>? IFrameParameters { get; set; }

    [Parameter]
    public EventCallback OnPaymentSuccess { get; set; }

    [Parameter]
    public EventCallback<string> OnPaymentFailed { get; set; }

    private bool IsLoading = false; // Ba≈ülangƒ±√ßta false - form hemen render olsun
    private string? ErrorMessage;
    private ElementReference paytrForm;
    private bool _formSubmitted = false;

    protected override void OnParametersSet()
    {
        // Parameters geldiƒüinde debug
        if (IFrameParameters != null)
        {
            // post_url kontrol√º
            if (!IFrameParameters.ContainsKey("post_url"))
            {
                ErrorMessage = "post_url parametresi eksik!";
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && IFrameParameters != null && !_formSubmitted)
        {
            try
            {
                // Form'un DOM'da render olmasƒ± i√ßin bekle
                await Task.Delay(500);
                
                // Form'u ID ile bul ve submit et
                await JSRuntime.InvokeVoidAsync("eval", @"
                    (function() {
                        console.log('=== PayTR Form Submit Ba≈ülƒ±yor ===');
                        var form = document.getElementById('paytr-form');
                        console.log('Form bulundu:', form !== null);
                        
                        if (form) {
                            console.log('Form action:', form.action);
                            console.log('Form target:', form.target);
                            console.log('Form method:', form.method);
                            
                            // Form i√ßindeki t√ºm input'larƒ± logla
                            var inputs = form.querySelectorAll('input');
                            console.log('Toplam input sayƒ±sƒ±:', inputs.length);
                            inputs.forEach(function(input) {
                                console.log('Input:', input.name, '=', input.value.substring(0, 20) + '...');
                            });
                            
                            // Form'u submit et
                            form.submit();
                            console.log('Form submit edildi!');
                        } else {
                            console.error('Form bulunamadƒ±!');
                        }
                    })();
                ");
                
                _formSubmitted = true;
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Hata: {ex.Message}";
                await JSRuntime.InvokeVoidAsync("console.error", "PayTR Error:", ex.Message);
                StateHasChanged();
            }
        }
    }

    private async Task OnIFrameLoad()
    {
        // iFrame y√ºklendiƒüinde loading'i kapat
        if (IsLoading)
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    public void ShowError(string message)
    {
        ErrorMessage = message;
        IsLoading = false;
        StateHasChanged();
    }
}

<style>
    .paytr-iframe-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }
</style>
