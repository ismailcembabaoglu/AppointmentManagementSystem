@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor
@inject IJSRuntime JSRuntime

<div class="paytr-iframe-container">
    @if (IsLoading)
    {
        <div style="text-align: center; padding: 40px;">
            <RadzenProgressBarCircular ShowValue="true" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            <RadzenText TextStyle="TextStyle.H6" Style="margin-top: 20px;">√ñdeme ekranƒ± y√ºkleniyor...</RadzenText>
        </div>
    }
    else if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
            <RadzenText TextStyle="TextStyle.H6" Style="margin-bottom: 8px;">Hata</RadzenText>
            <RadzenText>@ErrorMessage</RadzenText>
        </RadzenAlert>
    }
    else if (IFrameParameters != null)
    {
        <div style="background: white; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <RadzenText TextStyle="TextStyle.H5" Style="margin-bottom: 16px; text-align: center; color: var(--rz-primary);">
                üí≥ Kart Bilgilerinizi Girin
            </RadzenText>
            
            <RadzenAlert AlertStyle="AlertStyle.Info" Variant="Variant.Flat" Style="margin-bottom: 16px;">
                <RadzenText Style="font-size: 14px;">
                    üîí Kart bilgileriniz g√ºvenli bir ≈üekilde PayTR tarafƒ±ndan saklanacaktƒ±r. Aylƒ±k 700 TL abonelik √ºcreti otomatik olarak tahsil edilecektir.
                </RadzenText>
            </RadzenAlert>

            <form id="paytr-form" method="post" action="@IFrameParameters["post_url"]" target="paytr_iframe" style="display:none;">
                @foreach (var param in IFrameParameters)
                {
                    <input type="hidden" name="@param.Key" value="@param.Value" />
                }
            </form>

            <div style="width: 100%; height: 600px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: #f5f5f5;">
                <iframe id="paytr-iframe"
                        name="paytr_iframe" 
                        style="width: 100%; height: 100%; border: none; background: white;"
                        @onload="OnIFrameLoad">
                </iframe>
            </div>
            
            <div style="text-align: center; margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px;">
                <RadzenText TextStyle="TextStyle.Body2" Style="color: #1976d2;">
                    <strong>Test Kart Bilgileri:</strong><br/>
                    Kart No: 9792030394440796 | CVV: 000 | Tarih: Herhangi
                </RadzenText>
            </div>

            <RadzenText TextStyle="TextStyle.Caption" Style="text-align: center; margin-top: 16px; color: var(--rz-text-secondary-color);">
                ‚ö†Ô∏è Tarayƒ±cƒ± penceresini kapatmayƒ±n. √ñdeme i≈ülemi tamamlandƒ±ktan sonra otomatik olarak y√∂nlendirileceksiniz.
            </RadzenText>
        </div>
    }
</div>

@code {
    [Parameter]
    public Dictionary<string, string>? IFrameParameters { get; set; }

    [Parameter]
    public EventCallback OnPaymentSuccess { get; set; }

    [Parameter]
    public EventCallback<string> OnPaymentFailed { get; set; }

    private bool IsLoading = false; // Ba≈ülangƒ±√ßta false - form hemen render olsun
    private string? ErrorMessage;
    private ElementReference paytrForm;
    private bool _formSubmitted = false;

    protected override void OnParametersSet()
    {
        // Parameters geldiƒüinde debug
        if (IFrameParameters != null)
        {
            // post_url kontrol√º
            if (!IFrameParameters.ContainsKey("post_url"))
            {
                ErrorMessage = "post_url parametresi eksik!";
            }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && IFrameParameters != null && !_formSubmitted)
        {
            try
            {
                // Form'un DOM'da render olmasƒ± i√ßin kƒ±sa bekle
                await Task.Delay(300);
                
                // Form elementini bul ve submit et
                var formExists = await JSRuntime.InvokeAsync<bool>("eval", 
                    "document.querySelector('form[target=\"paytr_iframe\"]') !== null");
                
                await JSRuntime.InvokeVoidAsync("console.log", "Form exists:", formExists);
                
                if (formExists)
                {
                    await JSRuntime.InvokeVoidAsync("eval", 
                        "document.querySelector('form[target=\"paytr_iframe\"]').submit();");
                    _formSubmitted = true;
                    await JSRuntime.InvokeVoidAsync("console.log", "Form submitted successfully");
                }
                else
                {
                    ErrorMessage = "√ñdeme formu y√ºklenemedi.";
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Hata: {ex.Message}";
                await JSRuntime.InvokeVoidAsync("console.error", "PayTR Error:", ex.Message);
                StateHasChanged();
            }
        }
    }

    private async Task OnIFrameLoad()
    {
        // iFrame y√ºklendiƒüinde loading'i kapat
        if (IsLoading)
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    public void ShowError(string message)
    {
        ErrorMessage = message;
        IsLoading = false;
        StateHasChanged();
    }
}

<style>
    .paytr-iframe-container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
    }
</style>
