@page "/customer/ai-advisor"
@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.Application.DTOs.Ai
@using AppointmentManagementSystem.BlazorUI.Services
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices
@using Microsoft.AspNetCore.Components
@using System.Linq
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Customer")]
@inject IAiAssistantApiService AiAssistantApiService
@inject ICategoryApiService CategoryApiService
@inject NotificationService NotificationService
@inject NavigationManager Navigation

<PageTitle>Gemini İşletme Asistanı</PageTitle>

<RadzenCard Style="max-width: 1200px; margin: 0 auto; padding: 24px; box-shadow: var(--rz-shadow-3); border: 1px solid #e5e7eb;">
    <RadzenStack Orientation="Orientation.Vertical" Gap="24px">
        <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
            <RadzenText TextStyle="TextStyle.DisplayH6" Style="margin: 0; font-weight: 700;">Gemini destekli işletme rehberi</RadzenText>
            <RadzenText Style="color: var(--rz-text-secondary-color);">
                Bulunduğunuz il/ilçe ve kategoriye göre en iyi işletmeleri yapay zeka ile önerelim.
            </RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" Wrap="true">
                <RadzenBadge Icon="lightbulb" Style="background: #eef2ff; color: #4338ca;">Akıllı rehber</RadzenBadge>
                <RadzenBadge Icon="verified" Style="background: #ecfeff; color: #0ea5e9;">Güncel yorumlar</RadzenBadge>
                <RadzenBadge Icon="bolt" Style="background: #fef3c7; color: #d97706;">Hızlı aksiyon</RadzenBadge>
            </RadzenStack>
        </RadzenStack>

        <RadzenRow Gap="24px">
            <RadzenColumn Size="12" SizeMD="5">
                <RadzenCard Style="height: 100%; background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 100%); border: 1px solid #e5e7eb;">
                    <RadzenStack Orientation="Orientation.Vertical" Gap="12px">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="travel_explore" Style="color: #4338ca;" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Filtreler</RadzenText>
                        </RadzenStack>

                        <RadzenDropDown @bind-Value="requestModel.City"
                                        Data="cityOptions"
                                        Placeholder="Şehir seçin"
                                        Style="width: 100%;"
                                        Change="OnCityChanged" />

                        <RadzenDropDown @bind-Value="requestModel.District"
                                        Data="districtOptions"
                                        Placeholder="İlçe seçin"
                                        Disabled="string.IsNullOrEmpty(requestModel.City)"
                                        Style="width: 100%;" />

                        <RadzenDropDown @bind-Value="requestModel.CategoryId"
                                        Data="categories"
                                        TextProperty="Name"
                                        ValueProperty="Id"
                                        Placeholder="Kategori seçin"
                                        Style="width: 100%;" />

                        <RadzenNumeric @bind-Value="requestModel.MaxResults"
                                       Min="1"
                                       Max="5"
                                       Style="width: 100%;"
                                       ShowUpDown="true"
                                       Placeholder="Öneri sayısı" />

                        <RadzenTextArea @bind-Value="requestModel.Message"
                                         Placeholder="Örn: Kadıköy'de hafta sonu açık en iyi kadın kuaförü"
                                         Style="width: 100%; min-height: 140px;"
                                         Counter="true"
                                         MaxLength="400"
                                         ShowClear="true" />

                        <RadzenButton Icon="smart_toy"
                                      Disabled="isLoading"
                                      Click="SendRequest"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Style="width: 100%; box-shadow: var(--rz-shadow-2);">
                            <ChildContent>
                                @(isLoading ? "Öneriler hazırlanıyor..." : "Önerileri Getir")
                            </ChildContent>
                        </RadzenButton>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="7">
                <RadzenCard Style="height: 100%; min-height: 480px; background: linear-gradient(160deg, #ffffff 0%, #f8fafc 80%, #eef2ff 100%); border: 1px solid #e5e7eb;">
                    @if (isLoading)
                    {
                        <RadzenStack Orientation="Orientation.Vertical" Gap="16px" AlignItems="AlignItems.Center" Style="padding: 40px;">
                            <RadzenProgressBarCircular Mode="ProgressBarMode.Indeterminate" ShowValue="false" />
                            <RadzenText>Gemini önerileri hazırlanıyor...</RadzenText>
                        </RadzenStack>
                    }
                    else if (response != null)
                    {
                        <RadzenStack Orientation="Orientation.Vertical" Gap="16px">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center" Wrap="true">
                                <RadzenBadge Style="background: #ecfeff; color: #0284c7;" Icon="sell">@requestModel.City</RadzenBadge>
                                @if (!string.IsNullOrEmpty(requestModel.District))
                                {
                                    <RadzenBadge Style="background: #ecfeff; color: #0284c7;" Icon="location_on">@requestModel.District</RadzenBadge>
                                }
                                @if (requestModel.CategoryId.HasValue)
                                {
                                    var selectedCategory = categories.FirstOrDefault(c => c.Id == requestModel.CategoryId);
                                    if (selectedCategory != null)
                                    {
                                        <RadzenBadge Style="background: #fef3c7; color: #b45309;" Icon="category">@selectedCategory.Name</RadzenBadge>
                                    }
                                }
                                <RadzenBadge Style="background: #eef2ff; color: #4338ca;" Icon="bolt">@requestModel.MaxResults öneri</RadzenBadge>
                            </RadzenStack>

                            <div class="ai-chat-card">
                                <div class="ai-avatar">
                                    <RadzenIcon Icon="smart_toy" Style="color: white;" />
                                </div>
                                <div class="ai-bubble">
                                    <RadzenText Style="color: #0b1324;">@((MarkupString)FormatReply(response.Reply))</RadzenText>
                                </div>
                            </div>

                            @if (response.Recommendations.Any())
                            {
                                <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
                                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Öne çıkan işletmeler</RadzenText>
                                    <RadzenText Style="color: var(--rz-text-secondary-color);">Yorumlar ve puanlara göre en güçlü eşleşmeler. Hemen işletme sayfasına geçmek için kartın altındaki butona veya AI yanıtında gelen URL'lere tıklayabilirsin.</RadzenText>
                                </RadzenStack>
                                <RadzenRow Gap="16px">
                                    @foreach (var business in response.Recommendations)
                                    {
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenCard Style="height: 100%; border: 1px solid #e5e7eb; box-shadow: var(--rz-shadow-2);">
                                                <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="store" Style="color: var(--rz-primary-color);" />
                                                        <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">@business.Name</RadzenText>
                                                    </RadzenStack>
                                                    <RadzenText Style="color: var(--rz-text-secondary-color);">@business.Category</RadzenText>
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="star" Style="color: #f59e0b;" />
                                                        <RadzenText>@business.AverageRating.ToString("0.0")</RadzenText>
                                                        <RadzenText Style="color: var(--rz-text-secondary-color);">(@business.TotalRatings değerlendirme)</RadzenText>
                                                    </RadzenStack>
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="location_on" Style="color: #ef4444;" />
                                                        <RadzenText>@($"{business.City} / {business.District}")</RadzenText>
                                                    </RadzenStack>
                                                    @if (business.HighlightedReviews.Any())
                                                    {
                                                        <RadzenStack Orientation="Orientation.Vertical" Gap="6px">
                                                            <RadzenText TextStyle="TextStyle.Caption" Style="color: var(--rz-text-secondary-color);">Öne çıkan yorumlar</RadzenText>
                                                            @foreach (var review in business.HighlightedReviews)
                                                            {
                                                                <RadzenAlert Style="margin: 0;">@review</RadzenAlert>
                                                            }
                                                        </RadzenStack>
                                                    }
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="8px">
                                                        <RadzenButton Icon="open_in_new"
                                                                      ButtonStyle="ButtonStyle.Secondary"
                                                                      Size="ButtonSize.Small"
                                                                      Click="@(() => Navigation.NavigateTo($"/business/{business.BusinessId}"))">
                                                            İşletme sayfası
                                                        </RadzenButton>
                                                        <RadzenButton Icon="map"
                                                                      ButtonStyle="ButtonStyle.Light"
                                                                      Size="ButtonSize.Small"
                                                                      Click="@(() => Navigation.NavigateTo($"/business/{business.BusinessId}"))">
                                                            Rota & iletişim
                                                        </RadzenButton>
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenCard>
                                        </RadzenColumn>
                                    }
                                </RadzenRow>
                            }
                            else
                            {
                                <RadzenAlert Severity="AlertSeverity.Warning">Yapay zeka sonuç döndürmedi.</RadzenAlert>
                            }
                        </RadzenStack>
                    }
                    else
                    {
                        <RadzenStack Orientation="Orientation.Vertical" Gap="12px" AlignItems="AlignItems.Center" Style="padding: 40px;">
                            <RadzenIcon Icon="lightbulb" Style="font-size: 42px; color: var(--rz-primary-color);" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0;">Öneri almak için filtreleri doldurun</RadzenText>
                            <RadzenText Style="color: var(--rz-text-secondary-color); text-align: center;">
                                Örneğin: "Ankara Çankaya'da çocuk dostu diş kliniği arıyorum"
                            </RadzenText>
                        </RadzenStack>
                    }
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>
    </RadzenStack>
</RadzenCard>

@code {
    private List<CategoryDto> categories = new();
    private AiRecommendationRequestDto requestModel = new() { MaxResults = 3 };
    private AiRecommendationResponseDto? response;
    private bool isLoading;

    private IEnumerable<string> cityOptions => TurkishCityService.GetAllCities();
    private List<string> districtOptions => TurkishCityService.GetDistrictsByCity(requestModel.City ?? string.Empty);

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
    }

    private async Task LoadCategories()
    {
        var result = await CategoryApiService.GetAllCategoriesAsync();
        if (result.Success && result.Data != null)
        {
            categories = result.Data.Items.OrderBy(c => c.Name).ToList();
        }
    }

    private void OnCityChanged(object? value)
    {
        requestModel.District = null;
    }

    private async Task SendRequest()
    {
        if (string.IsNullOrWhiteSpace(requestModel.Message))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Mesaj gerekli", "Lütfen talebinizi yazın.");
            return;
        }

        isLoading = true;
        response = null;

        var apiResponse = await AiAssistantApiService.GetRecommendationsAsync(requestModel);
        isLoading = false;

        if (apiResponse.Success && apiResponse.Data != null)
        {
            response = apiResponse.Data;
            NotificationService.Notify(NotificationSeverity.Success, "Öneriler hazır", "Gemini'den gelen önerileri inceleyebilirsiniz.");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Hata", apiResponse.Message ?? "Bir hata oluştu.");
        }
    }

    private MarkupString FormatReply(string? reply)
    {
        if (string.IsNullOrWhiteSpace(reply))
        {
            return new MarkupString(string.Empty);
        }

        var withLinks = Regex.Replace(reply, @"(https?://[^\s]+)", match =>
        {
            var url = match.Groups[1].Value.TrimEnd('.');
            return $"<a href=\"{url}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"ai-link\">{url}</a>";
        }, RegexOptions.IgnoreCase | RegexOptions.Multiline);

        var normalized = withLinks.Replace("\r\n", "\n");
        normalized = Regex.Replace(normalized, "\n{2,}", "<br /><br />");
        normalized = Regex.Replace(normalized, "\n", "<br />");

        return new MarkupString(normalized);
    }
}

<style>
    .ai-chat-card {
        background: white;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        padding: 16px;
        display: flex;
        gap: 12px;
        box-shadow: var(--rz-shadow-2);
    }

    .ai-avatar {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(160deg, #4338ca, #312e81);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--rz-shadow-1);
    }

    .ai-bubble {
        flex: 1;
        background: #f8fafc;
        border-radius: 12px;
        padding: 12px 14px;
        border: 1px solid #e5e7eb;
        font-size: 14px;
        line-height: 1.6;
    }

    .ai-link {
        color: #2563eb;
        text-decoration: underline;
        font-weight: 600;
    }

    .ai-link:hover {
        color: #1d4ed8;
    }
</style>
