@page "/business/kart-yonetimi"
@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices
@using AppointmentManagementSystem.BlazorUI.Components
@using System.Globalization
@using System.Linq
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Business")]
@inject IPaymentApiService PaymentApiService
@inject AuthenticationStateProvider AuthStateProvider
@inject NotificationService NotificationService
@inject NavigationManager Navigation
@inject DialogService DialogService

<PageTitle>Kart Yönetimi</PageTitle>

@if (isLoading)
{
    <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Center" Gap="16px" Style="padding: 48px 0;">
        <RadzenProgressBarCircular ShowValue="false" ProgressBarStyle="ProgressBarStyle.Primary" />
        <RadzenText TextStyle="TextStyle.H6">Kart bilgileri yükleniyor...</RadzenText>
    </RadzenStack>
}
else if (!string.IsNullOrEmpty(loadError))
{
    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat" Shade="Shade.Lighter">
        <RadzenStack Orientation="Orientation.Vertical" Gap="8px">
            <RadzenText TextStyle="TextStyle.H6">Kart bilgileri alınamadı</RadzenText>
            <RadzenText>@loadError</RadzenText>
        </RadzenStack>
    </RadzenAlert>
}
else
{
    <RadzenStack Orientation="Orientation.Vertical" Gap="16px">
        <RadzenCard Style="background: linear-gradient(135deg, #111827 0%, #1f2937 100%); color: white; padding: 24px; border: none; box-shadow: 0 12px 30px rgba(17, 24, 39, 0.25);">
            <RadzenStack Orientation="Orientation.Vertical" Gap="12px">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12px" Wrap="FlexWrap.Wrap">
                    <RadzenIcon Icon="credit_card" Style="font-size: 36px; color: #a78bfa;" />
                    <RadzenText TextStyle="TextStyle.H4" Style="margin: 0; font-weight: 700;">Kart &amp; Abonelik</RadzenText>
                    <RadzenBadge Text="@(subscription?.SubscriptionStatus ?? "Bilinmiyor")" BadgeStyle="@GetSubscriptionBadgeStyle(subscription?.SubscriptionStatus)" />
                </RadzenStack>
                <RadzenText Style="color: rgba(255,255,255,0.85); margin: 0;">
                    PayTR Direct API ile kart bilgilerinizi güvenle güncelleyebilir ve abonelik ödemelerinizi tamamlayabilirsiniz.
                </RadzenText>
            </RadzenStack>
        </RadzenCard>

        <RadzenRow Gap="16px">
            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Style="border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);">
                    <RadzenStack Orientation="Orientation.Vertical" Gap="12px">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px">
                            <RadzenIcon Icon="lock" Style="color: var(--rz-primary-color);" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 700;">Mevcut Kart Bilgisi</RadzenText>
                        </RadzenStack>
                        <RadzenStack Orientation="Orientation.Vertical" Gap="4px">
                            <RadzenText TextStyle="TextStyle.Body1" Style="margin: 0; color: var(--rz-text-color);">
                                Kart: @(subscription?.MaskedCardNumber ?? "Kayıtlı kart bulunmuyor")
                            </RadzenText>
                            <RadzenText Style="color: var(--rz-text-secondary-color); margin: 0;">
                                Marka: @(subscription?.CardBrand ?? "-")
                            </RadzenText>
                        </RadzenStack>
                        <RadzenDivider Style="margin: 8px 0;" />
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="12px" Wrap="FlexWrap.Wrap">
                            <RadzenBadge Text="@($"Tutar: {(subscription?.MonthlyAmount ?? 0):0.00} TL")" BadgeStyle="BadgeStyle.Info" />
                            <RadzenBadge Text="@($"Son Tahsilat: {subscription?.LastBillingDate?.ToLocalTime().ToString("dd.MM.yyyy") ?? "-"}")" BadgeStyle="BadgeStyle.Light" />
                            <RadzenBadge Text="@($"Sonraki Tahsilat: {subscription?.NextBillingDate?.ToLocalTime().ToString("dd.MM.yyyy") ?? "-"}")" BadgeStyle="BadgeStyle.Light" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>

            <RadzenColumn Size="12" SizeMD="6">
                <RadzenCard Style="border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);">
                    <RadzenStack Orientation="Orientation.Vertical" Gap="12px">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px">
                            <RadzenIcon Icon="phone_iphone" Style="color: var(--rz-success-color);" />
                            <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 700;">Mobil Uyumlu Adımlar</RadzenText>
                        </RadzenStack>
                        <RadzenList Style="margin: 0;">
                            <Items>
                                <RadzenListItem>1 TL doğrulama işlemi için yeni kart bilgilerinizi girin.</RadzenListItem>
                                <RadzenListItem>Doğrulama tamamlanınca abonelik kartınız güncellenir.</RadzenListItem>
                                <RadzenListItem>Ödeme ekranı mobil uyumludur; ekranı kaydırarak tamamlayın.</RadzenListItem>
                            </Items>
                        </RadzenList>
                        <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="12px">
                            <RadzenText Style="color: var(--rz-text-secondary-color); margin: 0;">
                                PayTR Direct API: Kart bilgilerinizi güvenli şekilde güncelleyin
                            </RadzenText>
                            <RadzenButton Text="Kart Güncelle"
                                          Icon="credit_card"
                                          ButtonStyle="ButtonStyle.Success"
                                          Size="ButtonSize.Medium"
                                          Click="StartCardUpdatePayment"
                                          Style="min-width: 180px;" />
                        </RadzenStack>
                    </RadzenStack>
                </RadzenCard>
            </RadzenColumn>
        </RadzenRow>

        <RadzenCard Style="border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);">
            <RadzenStack Orientation="Orientation.Vertical" Gap="12px">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="8px">
                    <RadzenIcon Icon="event" Style="color: var(--rz-primary-color);" />
                    <RadzenText TextStyle="TextStyle.H6" Style="margin: 0; font-weight: 700;">Ay Seçerek Ödeme Yap</RadzenText>
                </RadzenStack>

                <RadzenRow Gap="12px">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Ödeme Ayı" Style="width: 100%;">
                            <RadzenDropDown @bind-Value="@selectedBillingPeriod"
                                            Data="@billingOptions"
                                            TextProperty="Label"
                                            ValueProperty="Period"
                                            Style="width: 100%;"
                                            Placeholder="Ay seçin" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Kart Üzerindeki İsim" Style="width: 100%;">
                            <RadzenTextBox @bind-Value="manualCardOwner"
                                           Placeholder="AHMET YILMAZ"
                                           Style="width: 100%; text-transform: uppercase;"
                                           Disabled="@paymentLoading" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="12px">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Kart Numarası" Style="width: 100%;">
                            <RadzenTextBox @bind-Value="manualCardNumber"
                                           Placeholder="1234 5678 9012 3456"
                                           @oninput="FormatManualCardNumber"
                                           MaxLength="19"
                                           Style="width: 100%; letter-spacing: 2px;"
                                           Disabled="@paymentLoading" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Son Kullanma Ay" Style="width: 100%;">
                            <RadzenDropDown @bind-Value="manualExpiryMonth"
                                            Data="months"
                                            Placeholder="Ay"
                                            Style="width: 100%;"
                                            Disabled="@paymentLoading" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="3">
                        <RadzenFormField Text="Son Kullanma Yıl" Style="width: 100%;">
                            <RadzenDropDown @bind-Value="manualExpiryYear"
                                            Data="years"
                                            Placeholder="Yıl"
                                            Style="width: 100%;"
                                            Disabled="@paymentLoading" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>

                <RadzenRow Gap="12px">
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="CVV" Style="width: 100%;">
                            <RadzenTextBox @bind-Value="manualCvv"
                                           Placeholder="123"
                                           MaxLength="4"
                                           Password="true"
                                           Style="width: 100%; text-align: center; letter-spacing: 2px;"
                                           Disabled="@paymentLoading" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6" Style="display: flex; align-items: flex-end;">
                        <RadzenButton Text="Seçili Ayı Öde"
                                      Icon="payments"
                                      ButtonStyle="ButtonStyle.Primary"
                                      Click="StartManualBillingPayment"
                                      Disabled="@(paymentLoading || !IsManualPaymentValid())"
                                      Style="width: 100%;" />
                    </RadzenColumn>
                </RadzenRow>

                @if (!string.IsNullOrEmpty(paymentError))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Danger" Variant="Variant.Flat">
                        <RadzenText>@paymentError</RadzenText>
                    </RadzenAlert>
                }

                @if (!string.IsNullOrEmpty(manualPaymentMessage))
                {
                    <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat">
                        <RadzenText>@manualPaymentMessage</RadzenText>
                    </RadzenAlert>
                }

                @if (paymentLoading)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12px">
                        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                        <RadzenText>Ödeme başlatılıyor...</RadzenText>
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenCard>

    </RadzenStack>
}

@code {
    private SubscriptionDto? subscription;
    private int businessId;
    private string? userEmail;
    private string? ownerName;
    private bool isLoading = true;
    private string? loadError;
    private string? paymentError;
    private string? manualPaymentMessage;
    private bool paymentLoading;
    private DateTime? selectedBillingPeriod;
    private List<BillingOption> billingOptions = new();
    private string manualCardOwner = string.Empty;
    private string manualCardNumber = string.Empty;
    private string manualExpiryMonth = string.Empty;
    private string manualExpiryYear = string.Empty;
    private string manualCvv = string.Empty;
    private List<string> months = Enumerable.Range(1, 12).Select(m => m.ToString("D2")).ToList();
    private List<string> years = Enumerable.Range(DateTime.Now.Year, 11).Select(y => y.ToString().Substring(2)).ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadSubscriptionAsync();
        BuildBillingOptions();
    }

    private async Task LoadSubscriptionAsync()
    {
        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated != true)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            var businessIdClaim = user.FindFirst("BusinessId") ?? user.FindFirst("businessId");
            userEmail = user.FindFirst("email")?.Value ?? user.Identity?.Name;
            ownerName = user.FindFirst("name")?.Value ?? user.Identity?.Name;

            if (businessIdClaim == null || !int.TryParse(businessIdClaim.Value, out businessId))
            {
                loadError = "İşletme bilgisi okunamadı.";
                return;
            }

            var subscriptionResponse = await PaymentApiService.GetSubscriptionAsync(businessId);
            if (subscriptionResponse.Success)
            {
                subscription = subscriptionResponse.Data;
            }
            else
            {
                loadError = subscriptionResponse.Message ?? "Abonelik bilgisi alınamadı.";
            }
        }
        catch (Exception ex)
        {
            loadError = $"Kart bilgileri alınırken hata oluştu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void BuildBillingOptions()
    {
        var culture = new CultureInfo("tr-TR");
        var startMonth = new DateTime(DateTime.UtcNow.Year, DateTime.UtcNow.Month, 1);

        billingOptions = Enumerable.Range(0, 12)
            .Select(i =>
            {
                var period = startMonth.AddMonths(i);
                return new BillingOption
                {
                    Period = period,
                    Label = period.ToString("MMMM yyyy", culture)
                };
            })
            .ToList();

        selectedBillingPeriod ??= billingOptions.FirstOrDefault()?.Period;
    }

    private void FormatManualCardNumber(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        var digitsOnly = new string(input.Where(char.IsDigit).ToArray());

        if (digitsOnly.Length > 16)
        {
            digitsOnly = digitsOnly[..16];
        }

        var formatted = string.Empty;
        for (var i = 0; i < digitsOnly.Length; i++)
        {
            if (i > 0 && i % 4 == 0)
            {
                formatted += " ";
            }

            formatted += digitsOnly[i];
        }

        manualCardNumber = formatted;
    }

    private bool IsManualPaymentValid()
    {
        var digitsOnly = new string(manualCardNumber.Where(char.IsDigit).ToArray());

        return !string.IsNullOrWhiteSpace(manualCardOwner)
               && digitsOnly.Length == 16
               && !string.IsNullOrWhiteSpace(manualExpiryMonth)
               && !string.IsNullOrWhiteSpace(manualExpiryYear)
               && manualCvv.Length is >= 3 and <= 4
               && selectedBillingPeriod != null;
    }

    private async Task StartManualBillingPayment()
    {
        if (businessId == 0 || string.IsNullOrEmpty(userEmail))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Eksik Bilgi", "İşletme veya kullanıcı bilgisi eksik.");
            return;
        }

        if (!IsManualPaymentValid())
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Uyarı", "Lütfen kart ve fatura dönemini eksiksiz doldurun.");
            return;
        }

        paymentError = null;
        manualPaymentMessage = null;
        paymentLoading = true;
        StateHasChanged();

        try
        {
            var digitsOnly = new string(manualCardNumber.Where(char.IsDigit).ToArray());
            var request = new ManualBillingRequestDto
            {
                BusinessId = businessId,
                BillingYear = selectedBillingPeriod.Value.Year,
                BillingMonth = selectedBillingPeriod.Value.Month,
                Email = userEmail ?? string.Empty,
                CustomerName = ownerName ?? string.Empty,
                CardOwner = manualCardOwner,
                CardNumber = digitsOnly,
                ExpiryMonth = manualExpiryMonth,
                ExpiryYear = manualExpiryYear,
                CVV = manualCvv
            };

            var response = await PaymentApiService.InitiateManualBillingAsync(request);

            if (response.Success)
            {
                manualPaymentMessage = response.Data?.Message ?? "Ödeme talebi gönderildi. Webhook ile teyit edilecek.";
                if (!string.IsNullOrEmpty(response.Data?.PaymentUrl))
                {
                    Navigation.NavigateTo(response.Data.PaymentUrl, true);
                }
                NotificationService.Notify(NotificationSeverity.Success, "Başarılı", manualPaymentMessage);
                await LoadSubscriptionAsync();
            }
            else
            {
                paymentError = response.Message ?? response.Errors?.FirstOrDefault() ?? "Ödeme başlatılamadı.";
            }
        }
        catch (Exception ex)
        {
            paymentError = $"Ödeme başlatılamadı: {ex.Message}";
        }
        finally
        {
            paymentLoading = false;
            StateHasChanged();
        }
    }

    private async Task StartCardUpdatePayment()
    {
        if (businessId == 0 || string.IsNullOrEmpty(userEmail))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Eksik Bilgi", "İşletme veya kullanıcı bilgisi eksik.");
            return;
        }

        paymentError = null;

        var parameters = new Dictionary<string, object>
        {
            { "BusinessId", businessId },
            { "Email", userEmail ?? string.Empty },
            { "BusinessName", subscription?.BusinessName ?? "İşletme" },
            { "OwnerName", ownerName ?? string.Empty }
        };

        var result = await DialogService.OpenAsync<DirectAPICardUpdateDialog>("Kart Güncelle", parameters, new DialogOptions
        {
            Width = "520px",
            AutoFocusFirstElement = true
        });

        if (result != null)
        {
            await LoadSubscriptionAsync();
        }
    }

    private BadgeStyle GetSubscriptionBadgeStyle(string? status)
    {
        return status?.ToLower() switch
        {
            "active" => BadgeStyle.Success,
            "suspended" => BadgeStyle.Warning,
            "expired" => BadgeStyle.Danger,
            _ => BadgeStyle.Light
        };
    }

    private class BillingOption
    {
        public DateTime Period { get; set; }
        public string Label { get; set; } = string.Empty;
    }
}
