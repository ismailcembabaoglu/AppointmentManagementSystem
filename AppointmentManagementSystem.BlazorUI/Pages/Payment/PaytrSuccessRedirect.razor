@page "/api/payments/success-redirect"
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

<PageTitle>Yönlendiriliyor...</PageTitle>

<div style="min-height: 60vh; display: flex; align-items: center; justify-content: center;">
    <div style="text-align: center;">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <div style="margin-top: 12px; color: #666;">Ödeme sonucu doğrulanıyor, lütfen bekleyin...</div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
                var query = uri.Query.TrimStart('?');

                Console.WriteLine($"=== PayTR Success Redirect ===");
                Console.WriteLine($"Full URL: {NavigationManager.Uri}");
                Console.WriteLine($"Query String: {uri.Query}");

                // PayTR POST ile form data gönderiyor olabilir, JavaScript ile kontrol edelim
                var formData = await JSRuntime.InvokeAsync<string>("eval", 
                    @"(function() {
                        const params = new URLSearchParams(window.location.search);
                        const result = {};
                        for (const [key, value] of params.entries()) {
                            result[key] = value;
                        }
                        return JSON.stringify(result);
                    })()");

                Console.WriteLine($"Form Data from JS: {formData}");

                var target = string.IsNullOrWhiteSpace(query)
                    ? "/payment/success"
                    : $"/payment/success?{query}";

                Console.WriteLine($"Redirecting to: {target}");
                NavigationManager.NavigateTo(target, forceLoad: false);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in PaytrSuccessRedirect: {ex.Message}");
                NavigationManager.NavigateTo("/payment/success", forceLoad: false);
            }
        }
    }
}
