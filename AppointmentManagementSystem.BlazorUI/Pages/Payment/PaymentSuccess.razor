@page "/payment/success"
@using Blazored.LocalStorage
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject HttpClient HttpClient
@inject IPaymentApiService PaymentApiService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage2
@using System.Linq
@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices

<PageTitle>Ã–deme BaÅŸarÄ±lÄ±</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <RadzenCard Style="max-width: 600px; padding: 48px; text-align: center;">
        @if (isProcessing)
        {
            <div style="margin-bottom: 24px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px;">
                Ã–demeniz iÅŸleniyor...
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-top: 8px;">
                LÃ¼tfen bekleyin, hesabÄ±nÄ±z aktifleÅŸtiriliyor.
            </RadzenText>
        }
        else
        {
            <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <RadzenIcon Icon="check" Style="font-size: 48px; color: white;" />
                </div>
            </div>

            <RadzenText TextStyle="TextStyle.H4" Style="color: #4caf50; margin-bottom: 16px;">
                ðŸŽ‰ Ã–deme BaÅŸarÄ±lÄ±!
            </RadzenText>

        <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 24px; color: #666;">
            Tebrikler! Ä°lk abonelik Ã¶demeniz (700 TL) baÅŸarÄ±yla alÄ±ndÄ±. 
            HesabÄ±nÄ±z aktifleÅŸtirildi ve hemen kullanmaya baÅŸlayabilirsiniz.
        </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Style="margin-bottom: 24px;">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>Ã–nemli:</strong> Kart bilgileriniz gÃ¼venli bir ÅŸekilde kaydedildi. 
                Bir sonraki Ã¶deme tarihiniz: <strong>@NextBillingDate</strong>
            </RadzenText>
        </RadzenAlert>

        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-bottom: 32px;">
            AylÄ±k 700 TL abonelik Ã¼creti otomatik olarak Ã§ekilecektir.
            Ä°stediÄŸiniz zaman aboneliÄŸinizi iptal edebilirsiniz.
        </RadzenText>

            <RadzenButton Text="GiriÅŸ Yap ve BaÅŸla" 
                          Click="@NavigateToLogin" 
                          ButtonStyle="ButtonStyle.Success" 
                          Size="ButtonSize.Large"
                          Style="width: 100%;" />
        }
    </RadzenCard>
</div>

@code {
    private string NextBillingDate => DateTime.Now.AddDays(30).ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
    private bool isProcessing = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // URL'den PayTR parametrelerini al
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            var merchantOid = query["merchant_oid"];
            var status = query["status"];
            var totalAmount = query["total_amount"];
            var hash = query["hash"];
            var utoken = query["utoken"];
            var ctoken = query["ctoken"];
            var cardType = query["card_type"];
            var maskedPan = query["masked_pan"];
            var paymentId = query["payment_id"];

            Console.WriteLine($"=== Payment Success Callback ===");
            Console.WriteLine($"Full URL: {NavigationManager.Uri}");
            Console.WriteLine($"Query String: {uri.Query}");
            Console.WriteLine($"MerchantOid: {merchantOid}");
            Console.WriteLine($"Status: {status}");
            Console.WriteLine($"TotalAmount: {totalAmount}");
            Console.WriteLine($"Utoken: {utoken}");
            Console.WriteLine($"Ctoken: {ctoken}");
            Console.WriteLine($"CardType: {cardType}");
            Console.WriteLine($"MaskedPan: {maskedPan}");

            // PayTR webhook'u otomatik olarak backend'e gelecek
            // Burada sadece gÃ¶rÃ¼ntÃ¼leme yapÄ±yoruz
            Console.WriteLine($"âœ… Payment success page loaded");
            Console.WriteLine($"MerchantOid: {merchantOid}");
            Console.WriteLine($"Status: {status}");
            Console.WriteLine($"PayTR webhook will be processed automatically by backend");
            
            // LocalStorage'Ä± temizle
            await LocalStorage.RemoveItemAsync("registrationBusinessId");
            await LocalStorage.RemoveItemAsync("registrationEmail");
            await LocalStorage.RemoveItemAsync("cardUpdateBusinessId");
            await LocalStorage.RemoveItemAsync("cardUpdateEmail");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment callback: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/login");
    }

    // Manuel webhook tetikleme kodlarÄ± kaldÄ±rÄ±ldÄ±
    // PayTR webhook'u otomatik olarak backend'e gelecek
}
