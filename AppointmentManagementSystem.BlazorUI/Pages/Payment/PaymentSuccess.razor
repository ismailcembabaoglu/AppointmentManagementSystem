@page "/payment/success"
@using Blazored.LocalStorage
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject HttpClient HttpClient
@inject IPaymentApiService PaymentApiService
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage2
@using System.Linq
@using AppointmentManagementSystem.Application.DTOs
@using AppointmentManagementSystem.BlazorUI.Services.ApiServices

<PageTitle>√ñdeme Ba≈üarƒ±lƒ±</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <RadzenCard Style="max-width: 600px; padding: 48px; text-align: center;">
        @if (isProcessing)
        {
            <div style="margin-bottom: 24px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px;">
                √ñdemeniz i≈üleniyor...
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-top: 8px;">
                L√ºtfen bekleyin, hesabƒ±nƒ±z aktifle≈ütiriliyor.
            </RadzenText>
        }
        else
        {
            <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <RadzenIcon Icon="check" Style="font-size: 48px; color: white;" />
                </div>
            </div>

            <RadzenText TextStyle="TextStyle.H4" Style="color: #4caf50; margin-bottom: 16px;">
                üéâ √ñdeme Ba≈üarƒ±lƒ±!
            </RadzenText>

        <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 24px; color: #666;">
            Tebrikler! ƒ∞lk abonelik √∂demeniz (700 TL) ba≈üarƒ±yla alƒ±ndƒ±. 
            Hesabƒ±nƒ±z aktifle≈ütirildi ve hemen kullanmaya ba≈ülayabilirsiniz.
        </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Style="margin-bottom: 24px;">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>√ñnemli:</strong> Kart bilgileriniz g√ºvenli bir ≈üekilde kaydedildi. 
                Bir sonraki √∂deme tarihiniz: <strong>@NextBillingDate</strong>
            </RadzenText>
        </RadzenAlert>

        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-bottom: 32px;">
            Aylƒ±k 700 TL abonelik √ºcreti otomatik olarak √ßekilecektir.
            ƒ∞stediƒüiniz zaman aboneliƒüinizi iptal edebilirsiniz.
        </RadzenText>

            <RadzenButton Text="Giri≈ü Yap ve Ba≈üla" 
                          Click="@NavigateToLogin" 
                          ButtonStyle="ButtonStyle.Success" 
                          Size="ButtonSize.Large"
                          Style="width: 100%;" />
        }
    </RadzenCard>
</div>

@code {
    private string NextBillingDate => DateTime.Now.AddDays(30).ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
    private bool isProcessing = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // URL'den PayTR parametrelerini al
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            var merchantOid = query["merchant_oid"];
            var status = query["status"];
            var totalAmount = query["total_amount"];
            var hash = query["hash"];
            var utoken = query["utoken"];
            var ctoken = query["ctoken"];
            var cardType = query["card_type"];
            var maskedPan = query["masked_pan"];
            var paymentId = query["payment_id"];

            Console.WriteLine($"=== Payment Success Callback ===");
            Console.WriteLine($"Full URL: {NavigationManager.Uri}");
            Console.WriteLine($"Query String: {uri.Query}");
            Console.WriteLine($"MerchantOid: {merchantOid}");
            Console.WriteLine($"Status: {status}");
            Console.WriteLine($"TotalAmount: {totalAmount}");
            Console.WriteLine($"Utoken: {utoken}");
            Console.WriteLine($"Ctoken: {ctoken}");
            Console.WriteLine($"CardType: {cardType}");
            Console.WriteLine($"MaskedPan: {maskedPan}");

            var completionHandled = await TryCompleteCardRegistrationAsync(
                merchantOid,
                status,
                totalAmount,
                utoken,
                ctoken,
                cardType,
                maskedPan,
                paymentId);

            if (completionHandled)
            {
                isProcessing = false;
                StateHasChanged();
                return;
            }

            Console.WriteLine($"‚ö†Ô∏è Webhook not sent - falling back to manual trigger");

            var manualTriggered = await TryManualWebhookFromLocalStorage();
            if (manualTriggered)
            {
                isProcessing = false;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment callback: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/login");
    }

    private async Task<bool> TryCompleteCardRegistrationAsync(
        string? merchantOid,
        string? status,
        string? totalAmount,
        string? utoken,
        string? ctoken,
        string? cardType,
        string? maskedPan,
        string? paymentId)
    {
        if (status != "success")
        {
            return false;
        }

        if (string.IsNullOrWhiteSpace(utoken) && string.IsNullOrWhiteSpace(ctoken))
        {
            Console.WriteLine("‚ö†Ô∏è No PayTR tokens returned, skipping direct completion");
            return false;
        }

        var businessId = ParseBusinessId(merchantOid);
        var storedCardUpdateBusinessId = await LocalStorage.GetItemAsync<int?>("cardUpdateBusinessId");
        var storedRegistrationBusinessId = await LocalStorage.GetItemAsync<int?>("registrationBusinessId");

        businessId ??= storedCardUpdateBusinessId ?? storedRegistrationBusinessId;

        if (!businessId.HasValue)
        {
            Console.WriteLine("‚ö†Ô∏è BusinessId could not be resolved for direct completion");
            return false;
        }

        var completeRequest = new CompleteCardRegistrationDto
        {
            BusinessId = businessId.Value,
            MerchantOid = merchantOid ?? $"CARD{businessId.Value}{Guid.NewGuid():N}",
            Utoken = utoken,
            Ctoken = ctoken,
            CardType = cardType,
            MaskedPan = maskedPan,
            PaymentId = paymentId,
            TotalAmount = totalAmount,
            IsCardUpdate = merchantOid?.StartsWith("CARD") == true || storedCardUpdateBusinessId.HasValue
        };

        var response = await PaymentApiService.CompleteCardRegistrationAsync(completeRequest);

        if (response.Success)
        {
            Console.WriteLine("‚úÖ Direct card completion succeeded");
            await ClearLocalStorageFlags(completeRequest.IsCardUpdate);
            return true;
        }

        Console.WriteLine($"‚ùå Direct card completion failed: {response.Message}");
        return false;
    }

    private static int? ParseBusinessId(string? merchantOid)
    {
        if (string.IsNullOrWhiteSpace(merchantOid))
        {
            return null;
        }

        var trimmed = merchantOid.Trim();
        var digits = new string(trimmed.SkipWhile(c => !char.IsDigit(c)).TakeWhile(char.IsDigit).ToArray());

        if (int.TryParse(digits, out var businessId))
        {
            return businessId;
        }

        return null;
    }

    private async Task ClearLocalStorageFlags(bool isCardUpdate)
    {
        if (isCardUpdate)
        {
            await LocalStorage.RemoveItemAsync("cardUpdateBusinessId");
            await LocalStorage.RemoveItemAsync("cardUpdateEmail");
        }
        else
        {
            await LocalStorage.RemoveItemAsync("registrationBusinessId");
            await LocalStorage.RemoveItemAsync("registrationEmail");
        }
    }

    private async Task<bool> TryManualWebhookFromLocalStorage()
    {
        var cardUpdateBusinessId = await LocalStorage.GetItemAsync<int?>("cardUpdateBusinessId");
        var cardUpdateEmail = await LocalStorage.GetItemAsStringAsync("cardUpdateEmail");
        var businessId = await LocalStorage.GetItemAsync<int?>("registrationBusinessId");
        var email = await LocalStorage.GetItemAsStringAsync("registrationEmail");

        if (cardUpdateBusinessId.HasValue)
        {
            Console.WriteLine($"‚úÖ Card update detected in localStorage: {cardUpdateBusinessId}");

            var guidPart = "A"+Guid.NewGuid().ToString("N").Substring(0, 7).ToUpperInvariant();
            var merchantOid = $"CARD{cardUpdateBusinessId}{guidPart}";
            Console.WriteLine($"Generated CARD MerchantOid: {merchantOid}");

            var formData = new Dictionary<string, string>
            {
                { "merchant_oid", merchantOid },
                { "status", "success" },
                { "total_amount", "100" }, // 1 TL doƒürulama
                { "hash", "test_hash_for_card_update" },
                { "utoken", $"CARD_UTOKEN_{cardUpdateBusinessId}_{DateTime.Now.Ticks}" },
                { "ctoken", $"CARD_CTOKEN_{cardUpdateBusinessId}_{DateTime.Now.Ticks}" },
                { "card_type", "Visa" },
                { "masked_pan", "****1111" },
                { "payment_id", $"CARD_PAY_{DateTime.Now.Ticks}" },
                { "failed_reason_msg", "" }
            };

            Console.WriteLine($"üì§ Sending manual CARD webhook to API...");
            var content = new FormUrlEncodedContent(formData);
            var response = await HttpClient.PostAsync("api/payments/webhook", content);

            Console.WriteLine($"Webhook response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("‚úÖ Manual card update webhook successful!");
                await LocalStorage.RemoveItemAsync("cardUpdateBusinessId");
                await LocalStorage.RemoveItemAsync("cardUpdateEmail");
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Manual card update webhook error: {errorText}");
            }

            return true;
        }

        if (businessId.HasValue)
        {
            Console.WriteLine($"‚úÖ Found BusinessId in localStorage: {businessId}");
            Console.WriteLine($"‚úÖ Found Email in localStorage: {email}");

            // PayTr test mode'unda callback parametreleri gelmiyor
            // Manuel olarak webhook tetikle
            Console.WriteLine($"üîß PayTR test mode detected - triggering manual webhook...");

            // Generate test merchant_oid from businessId without special characters
            // Format: REG{businessId}{guid}
            var guidPart = "A"+Guid.NewGuid().ToString("N").Substring(0, 7).ToUpperInvariant();
            var merchantOid = $"REG{businessId}{guidPart}";
            Console.WriteLine($"Generated MerchantOid: {merchantOid}");

            // Manuel webhook data olu≈ütur
            var formData = new Dictionary<string, string>
            {
                { "merchant_oid", merchantOid },
                { "status", "success" },
                { "total_amount", "70000" }, // 700 TL
                { "hash", "test_hash_for_development" },
                { "utoken", $"TEST_UTOKEN_{businessId}_{DateTime.Now.Ticks}" },
                { "ctoken", $"TEST_CTOKEN_{businessId}_{DateTime.Now.Ticks}" },
                { "card_type", "Visa" },
                { "masked_pan", "****1234" },
                { "payment_id", $"TEST_PAY_{DateTime.Now.Ticks}" },
                { "failed_reason_msg", "" }
            };

            Console.WriteLine($"üì§ Sending manual webhook to API...");
            var content = new FormUrlEncodedContent(formData);
            var response = await HttpClient.PostAsync("api/payments/webhook", content);

            Console.WriteLine($"Webhook response status: {response.StatusCode}");

            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine("‚úÖ Manual webhook successful - Business activated!");
                await LocalStorage.RemoveItemAsync("registrationBusinessId");
                await LocalStorage.RemoveItemAsync("registrationEmail");
            }
            else
            {
                var errorText = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Manual webhook error: {errorText}");
            }

            return true;
        }

        return false;
    }
}
