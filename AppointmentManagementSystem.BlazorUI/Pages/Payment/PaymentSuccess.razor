@page "/payment/success"
@using Blazored.LocalStorage
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject HttpClient HttpClient
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage2

<PageTitle>√ñdeme Ba≈üarƒ±lƒ±</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <RadzenCard Style="max-width: 600px; padding: 48px; text-align: center;">
        @if (isProcessing)
        {
            <div style="margin-bottom: 24px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px;">
                √ñdemeniz i≈üleniyor...
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-top: 8px;">
                L√ºtfen bekleyin, hesabƒ±nƒ±z aktifle≈ütiriliyor.
            </RadzenText>
        }
        else
        {
            <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <RadzenIcon Icon="check" Style="font-size: 48px; color: white;" />
                </div>
            </div>

            <RadzenText TextStyle="TextStyle.H4" Style="color: #4caf50; margin-bottom: 16px;">
                üéâ √ñdeme Ba≈üarƒ±lƒ±!
            </RadzenText>

        <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 24px; color: #666;">
            Tebrikler! ƒ∞lk abonelik √∂demeniz (700 TL) ba≈üarƒ±yla alƒ±ndƒ±. 
            Hesabƒ±nƒ±z aktifle≈ütirildi ve hemen kullanmaya ba≈ülayabilirsiniz.
        </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Style="margin-bottom: 24px;">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>√ñnemli:</strong> Kart bilgileriniz g√ºvenli bir ≈üekilde kaydedildi. 
                Bir sonraki √∂deme tarihiniz: <strong>@NextBillingDate</strong>
            </RadzenText>
        </RadzenAlert>

        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-bottom: 32px;">
            Aylƒ±k 700 TL abonelik √ºcreti otomatik olarak √ßekilecektir.
            ƒ∞stediƒüiniz zaman aboneliƒüinizi iptal edebilirsiniz.
        </RadzenText>

            <RadzenButton Text="Giri≈ü Yap ve Ba≈üla" 
                          Click="@NavigateToLogin" 
                          ButtonStyle="ButtonStyle.Success" 
                          Size="ButtonSize.Large"
                          Style="width: 100%;" />
        }
    </RadzenCard>
</div>

@code {
    private string NextBillingDate => DateTime.Now.AddDays(30).ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
    private bool isProcessing = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // URL'den PayTR parametrelerini al
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            var merchantOid = query["merchant_oid"];
            var status = query["status"];
            var totalAmount = query["total_amount"];
            var hash = query["hash"];
            var utoken = query["utoken"];
            var ctoken = query["ctoken"];
            var cardType = query["card_type"];
            var maskedPan = query["masked_pan"];
            var paymentId = query["payment_id"];

            Console.WriteLine($"=== Payment Success Callback ===");
            Console.WriteLine($"MerchantOid: {merchantOid}");
            Console.WriteLine($"Status: {status}");
            Console.WriteLine($"TotalAmount: {totalAmount}");
            Console.WriteLine($"Utoken: {utoken}");
            Console.WriteLine($"Ctoken: {ctoken}");
            Console.WriteLine($"CardType: {cardType}");
            Console.WriteLine($"MaskedPan: {maskedPan}");

            if (!string.IsNullOrEmpty(merchantOid) && status == "success")
            {
                // API'ye webhook sim√ºlasyonu g√∂nder - FormData formatƒ±nda
                var formData = new Dictionary<string, string>
                {
                    { "merchant_oid", merchantOid ?? "" },
                    { "status", status ?? "" },
                    { "total_amount", totalAmount ?? "" },
                    { "hash", hash ?? "" },
                    { "utoken", utoken ?? "" },
                    { "ctoken", ctoken ?? "" },
                    { "card_type", cardType ?? "" },
                    { "masked_pan", maskedPan ?? "" },
                    { "payment_id", paymentId ?? "" },
                    { "failed_reason_msg", "" }
                };

                Console.WriteLine($"Sending webhook to API...");
                var content = new FormUrlEncodedContent(formData);
                var response = await HttpClient.PostAsync("api/payments/webhook", content);
                
                Console.WriteLine($"Webhook response status: {response.StatusCode}");
                
                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine("‚úÖ Webhook successful - Business activated!");
                    // Ba≈üarƒ±lƒ± - business aktifle≈ütirildi ve abonelik olu≈üturuldu
                    await LocalStorage.RemoveItemAsync("registrationBusinessId");
                }
                else
                {
                    var errorText = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"‚ùå Webhook error: {errorText}");
                    Console.WriteLine($"Response content: {errorText}");
                }
            }
            else
            {
                Console.WriteLine($"‚ö†Ô∏è Webhook not sent - MerchantOid: {merchantOid}, Status: {status}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment callback: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/login");
    }
}
