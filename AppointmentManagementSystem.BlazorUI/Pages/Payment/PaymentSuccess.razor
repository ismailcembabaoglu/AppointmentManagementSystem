@page "/payment/success"
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject HttpClient HttpClient
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage2

<PageTitle>Ã–deme BaÅŸarÄ±lÄ±</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <RadzenCard Style="max-width: 600px; padding: 48px; text-align: center;">
        @if (isProcessing)
        {
            <div style="margin-bottom: 24px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px;">
                Ã–demeniz iÅŸleniyor...
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-top: 8px;">
                LÃ¼tfen bekleyin, hesabÄ±nÄ±z aktifleÅŸtiriliyor.
            </RadzenText>
        }
        else
        {
            <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <RadzenIcon Icon="check" Style="font-size: 48px; color: white;" />
                </div>
            </div>

            <RadzenText TextStyle="TextStyle.H4" Style="color: #4caf50; margin-bottom: 16px;">
                ðŸŽ‰ Ã–deme BaÅŸarÄ±lÄ±!
            </RadzenText>

        <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 24px; color: #666;">
            Tebrikler! Ä°lk abonelik Ã¶demeniz (700 TL) baÅŸarÄ±yla alÄ±ndÄ±. 
            HesabÄ±nÄ±z aktifleÅŸtirildi ve hemen kullanmaya baÅŸlayabilirsiniz.
        </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Style="margin-bottom: 24px;">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>Ã–nemli:</strong> Kart bilgileriniz gÃ¼venli bir ÅŸekilde kaydedildi. 
                Bir sonraki Ã¶deme tarihiniz: <strong>@NextBillingDate</strong>
            </RadzenText>
        </RadzenAlert>

        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-bottom: 32px;">
            AylÄ±k 700 TL abonelik Ã¼creti otomatik olarak Ã§ekilecektir.
            Ä°stediÄŸiniz zaman aboneliÄŸinizi iptal edebilirsiniz.
        </RadzenText>

            <RadzenButton Text="GiriÅŸ Yap ve BaÅŸla" 
                          Click="@NavigateToLogin" 
                          ButtonStyle="ButtonStyle.Success" 
                          Size="ButtonSize.Large"
                          Style="width: 100%;" />
        }
    </RadzenCard>
</div>

@code {
    private string NextBillingDate => DateTime.Now.AddDays(30).ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
    private bool isProcessing = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // URL'den PayTR parametrelerini al
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            var merchantOid = query["merchant_oid"];
            var status = query["status"];
            var totalAmount = query["total_amount"];
            var hash = query["hash"];
            var utoken = query["utoken"];
            var ctoken = query["ctoken"];
            var cardType = query["card_type"];
            var maskedPan = query["masked_pan"];
            var paymentId = query["payment_id"];

            if (!string.IsNullOrEmpty(merchantOid) && status == "success")
            {
                // API'ye webhook simÃ¼lasyonu gÃ¶nder - FormData formatÄ±nda
                var formData = new Dictionary<string, string>
                {
                    { "merchant_oid", merchantOid ?? "" },
                    { "status", status ?? "" },
                    { "total_amount", totalAmount ?? "" },
                    { "hash", hash ?? "" },
                    { "utoken", utoken ?? "" },
                    { "ctoken", ctoken ?? "" },
                    { "card_type", cardType ?? "" },
                    { "masked_pan", maskedPan ?? "" },
                    { "payment_id", paymentId ?? "" },
                    { "failed_reason_msg", "" }
                };

                var content = new FormUrlEncodedContent(formData);
                var response = await HttpClient.PostAsync("api/payments/webhook", content);
                
                if (response.IsSuccessStatusCode)
                {
                    // BaÅŸarÄ±lÄ± - business aktifleÅŸtirildi ve abonelik oluÅŸturuldu
                    await LocalStorage.RemoveItemAsync("registrationBusinessId");
                }
                else
                {
                    var errorText = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"Webhook error: {errorText}");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment callback: {ex.Message}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/login");
    }
}
