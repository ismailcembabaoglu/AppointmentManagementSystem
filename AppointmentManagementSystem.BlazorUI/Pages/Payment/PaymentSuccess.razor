@page "/payment/success"
@using Blazored.LocalStorage
@inject NavigationManager NavigationManager
@inject ILocalStorageService LocalStorage
@inject HttpClient HttpClient
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage2

<PageTitle>√ñdeme Ba≈üarƒ±lƒ±</PageTitle>

<div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <RadzenCard Style="max-width: 600px; padding: 48px; text-align: center;">
        @if (isProcessing)
        {
            <div style="margin-bottom: 24px;">
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Large" />
            </div>
            <RadzenText TextStyle="TextStyle.H5" Style="margin-top: 16px;">
                √ñdemeniz i≈üleniyor...
            </RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-top: 8px;">
                L√ºtfen bekleyin, hesabƒ±nƒ±z aktifle≈ütiriliyor.
            </RadzenText>
        }
        else
        {
            <div style="margin-bottom: 24px;">
                <div style="width: 80px; height: 80px; margin: 0 auto; background: #4caf50; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <RadzenIcon Icon="check" Style="font-size: 48px; color: white;" />
                </div>
            </div>

            <RadzenText TextStyle="TextStyle.H4" Style="color: #4caf50; margin-bottom: 16px;">
                üéâ √ñdeme Ba≈üarƒ±lƒ±!
            </RadzenText>

        <RadzenText TextStyle="TextStyle.Body1" Style="margin-bottom: 24px; color: #666;">
            Tebrikler! ƒ∞lk abonelik √∂demeniz (700 TL) ba≈üarƒ±yla alƒ±ndƒ±. 
            Hesabƒ±nƒ±z aktifle≈ütirildi ve hemen kullanmaya ba≈ülayabilirsiniz.
        </RadzenText>

        <RadzenAlert AlertStyle="AlertStyle.Success" Variant="Variant.Flat" Style="margin-bottom: 24px;">
            <RadzenText TextStyle="TextStyle.Body2">
                <strong>√ñnemli:</strong> Kart bilgileriniz g√ºvenli bir ≈üekilde kaydedildi. 
                Bir sonraki √∂deme tarihiniz: <strong>@NextBillingDate</strong>
            </RadzenText>
        </RadzenAlert>

        <RadzenText TextStyle="TextStyle.Body2" Style="color: #888; margin-bottom: 32px;">
            Aylƒ±k 700 TL abonelik √ºcreti otomatik olarak √ßekilecektir.
            ƒ∞stediƒüiniz zaman aboneliƒüinizi iptal edebilirsiniz.
        </RadzenText>

            <RadzenButton Text="Giri≈ü Yap ve Ba≈üla" 
                          Click="@NavigateToLogin" 
                          ButtonStyle="ButtonStyle.Success" 
                          Size="ButtonSize.Large"
                          Style="width: 100%;" />
        }
    </RadzenCard>
</div>

@code {
    private string NextBillingDate => DateTime.Now.AddDays(30).ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("tr-TR"));
    private bool isProcessing = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // URL'den PayTR parametrelerini al
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

            var merchantOid = query["merchant_oid"];
            var status = query["status"];
            var totalAmount = query["total_amount"];
            var hash = query["hash"];
            var utoken = query["utoken"];
            var ctoken = query["ctoken"];
            var cardType = query["card_type"];
            var maskedPan = query["masked_pan"];
            var paymentId = query["payment_id"];

            Console.WriteLine($"=== Payment Success Callback ===");
            Console.WriteLine($"Full URL: {NavigationManager.Uri}");
            Console.WriteLine($"Query String: {uri.Query}");
            Console.WriteLine($"MerchantOid: {merchantOid}");
            Console.WriteLine($"Status: {status}");
            Console.WriteLine($"TotalAmount: {totalAmount}");
            Console.WriteLine($"Utoken: {utoken}");
            Console.WriteLine($"Ctoken: {ctoken}");
            Console.WriteLine($"CardType: {cardType}");
            Console.WriteLine($"MaskedPan: {maskedPan}");

            // Eƒüer URL'de parametreler yoksa, localStorage'dan businessId'yi al ve manuel webhook tetikle
            if (string.IsNullOrEmpty(merchantOid))
            {
                Console.WriteLine($"‚ö†Ô∏è No parameters in URL, checking localStorage...");
                var businessId = await LocalStorage.GetItemAsync<int?>("registrationBusinessId");
                var email = await LocalStorage.GetItemAsStringAsync("registrationEmail");
                
                if (businessId.HasValue)
                {
                    Console.WriteLine($"‚úÖ Found BusinessId in localStorage: {businessId}");
                    Console.WriteLine($"‚úÖ Found Email in localStorage: {email}");
                    
                    // PayTr test mode'unda callback parametreleri gelmiyor
                    // Manuel olarak webhook tetikle
                    Console.WriteLine($"üîß PayTR test mode detected - triggering manual webhook...");
                    
                    // Generate test merchant_oid from businessId without special characters
                    // Format: REG{businessId}{guid}
                    var guidPart = Guid.NewGuid().ToString("N").Substring(0, 8).ToUpperInvariant();
                    merchantOid = $"REG{businessId}{guidPart}";
                    Console.WriteLine($"Generated MerchantOid: {merchantOid}");
                    
                    // Manuel webhook data olu≈ütur
                    var formData = new Dictionary<string, string>
                    {
                        { "merchant_oid", merchantOid },
                        { "status", "success" },
                        { "total_amount", "70000" }, // 700 TL
                        { "hash", "test_hash_for_development" },
                        { "utoken", $"TEST_UTOKEN_{businessId}_{DateTime.Now.Ticks}" },
                        { "ctoken", $"TEST_CTOKEN_{businessId}_{DateTime.Now.Ticks}" },
                        { "card_type", "Visa" },
                        { "masked_pan", "****1234" },
                        { "payment_id", $"TEST_PAY_{DateTime.Now.Ticks}" },
                        { "failed_reason_msg", "" }
                    };

                    Console.WriteLine($"üì§ Sending manual webhook to API...");
                    var content = new FormUrlEncodedContent(formData);
                    var response = await HttpClient.PostAsync("api/payments/webhook", content);
                    
                    Console.WriteLine($"Webhook response status: {response.StatusCode}");
                    
                    if (response.IsSuccessStatusCode)
                    {
                        Console.WriteLine("‚úÖ Manual webhook successful - Business activated!");
                        await LocalStorage.RemoveItemAsync("registrationBusinessId");
                        await LocalStorage.RemoveItemAsync("registrationEmail");
                    }
                    else
                    {
                        var errorText = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"‚ùå Manual webhook error: {errorText}");
                    }
                    
                    isProcessing = false;
                    StateHasChanged();
                    return;
                }
                else
                {
                    Console.WriteLine($"‚ùå No BusinessId in localStorage");
                    Console.WriteLine($"‚ö†Ô∏è Payment may have been processed but we cannot activate business");
                }
            }

            if (!string.IsNullOrEmpty(merchantOid) && status == "success")
            {
                // API'ye webhook sim√ºlasyonu g√∂nder - FormData formatƒ±nda
                var formData = new Dictionary<string, string>
                {
                    { "merchant_oid", merchantOid ?? "" },
                    { "status", status ?? "" },
                    { "total_amount", totalAmount ?? "" },
                    { "hash", hash ?? "" },
                    { "utoken", utoken ?? "" },
                    { "ctoken", ctoken ?? "" },
                    { "card_type", cardType ?? "" },
                    { "masked_pan", maskedPan ?? "" },
                    { "payment_id", paymentId ?? "" },
                    { "failed_reason_msg", "" }
                };

                Console.WriteLine($"Sending webhook to API...");
                var content = new FormUrlEncodedContent(formData);
                var response = await HttpClient.PostAsync("api/payments/webhook", content);
                
                Console.WriteLine($"Webhook response status: {response.StatusCode}");
                
                if (response.IsSuccessStatusCode)
                {
                    Console.WriteLine("‚úÖ Webhook successful - Business activated!");
                    // Ba≈üarƒ±lƒ± - business aktifle≈ütirildi ve abonelik olu≈üturuldu
                    await LocalStorage.RemoveItemAsync("registrationBusinessId");
                }
                else
                {
                    var errorText = await response.Content.ReadAsStringAsync();
                    Console.WriteLine($"‚ùå Webhook error: {errorText}");
                    Console.WriteLine($"Response content: {errorText}");
                }
            }
            else
            {
                Console.WriteLine($"‚ö†Ô∏è Webhook not sent - MerchantOid: {merchantOid}, Status: {status}");
                Console.WriteLine($"üí° PayTR should automatically add these parameters to the success URL.");
                Console.WriteLine($"üí° Make sure merchant_ok_url is correctly configured in PayTR dashboard.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error processing payment callback: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private void NavigateToLogin()
    {
        NavigationManager.NavigateTo("/login");
    }
}
